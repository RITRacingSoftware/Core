\doxysection{src/driver/\+Src/usart.c File Reference}
\hypertarget{usart_8c}{}\label{usart_8c}\index{src/driver/Src/usart.c@{src/driver/Src/usart.c}}


Core UART library.  


{\ttfamily \#include "{}usart.\+h"{}}\newline
{\ttfamily \#include "{}core\+\_\+config.\+h"{}}\newline
{\ttfamily \#include $<$stdint.\+h$>$}\newline
{\ttfamily \#include $<$stdbool.\+h$>$}\newline
{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$stdarg.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$stm32g4xx\+\_\+hal.\+h$>$}\newline
{\ttfamily \#include $<$stm32g4xx\+\_\+hal\+\_\+usart.\+h$>$}\newline
{\ttfamily \#include "{}clock.\+h"{}}\newline
{\ttfamily \#include "{}gpio.\+h"{}}\newline
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
bool \mbox{\hyperlink{usart_8c_a35dc06127bee8b23c08e4ec63aab66d3}{core\+\_\+\+USART\+\_\+init}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart, uint32\+\_\+t baud)
\begin{DoxyCompactList}\small\item\em Initialize a USART module in asynchronous mode with the given baud rate. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{usart_8c_a080787d9baeec30dbb2639ab958893bd}{core\+\_\+\+USART\+\_\+start\+\_\+rx}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart, volatile uint8\+\_\+t \texorpdfstring{$\ast$}{*}rxbuf, volatile uint32\+\_\+t \texorpdfstring{$\ast$}{*}rxbuflen)
\begin{DoxyCompactList}\small\item\em Start the receiver for the given USART module. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{usart_8c_a98eee6d24e7130a4a1c8527c207843a3}{core\+\_\+\+USART\+\_\+register\+\_\+callback}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart, void(\texorpdfstring{$\ast$}{*}callback)(uint8\+\_\+t \texorpdfstring{$\ast$}{*}, uint32\+\_\+t))
\begin{DoxyCompactList}\small\item\em Set the RX callback and start the receiver for the given USART module. \end{DoxyCompactList}\item 
\Hypertarget{usart_8c_a27fb9800d727337121da9525aca0b557}\label{usart_8c_a27fb9800d727337121da9525aca0b557} 
void {\bfseries USART1\+\_\+\+IRQHandler} ()
\item 
\Hypertarget{usart_8c_adec38e248f7515f0ee427630d5ff98ba}\label{usart_8c_adec38e248f7515f0ee427630d5ff98ba} 
void {\bfseries USART2\+\_\+\+IRQHandler} ()
\item 
\Hypertarget{usart_8c_a7ef0c8dc631c3684df826336b678dda0}\label{usart_8c_a7ef0c8dc631c3684df826336b678dda0} 
void {\bfseries USART3\+\_\+\+IRQHandler} ()
\item 
void \mbox{\hyperlink{usart_8c_aa6d598f617dc2068c62544b474bc5960}{core\+\_\+\+USART\+\_\+update\+\_\+disable}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart)
\begin{DoxyCompactList}\small\item\em Disable updating the RX buffer for the given USART. Use this before reading from the buffer to which data is stored to prevent corruption. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{usart_8c_a1c56db6aae9393622a2d93a74ec0b1d5}{core\+\_\+\+USART\+\_\+update\+\_\+enable}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart)
\begin{DoxyCompactList}\small\item\em Enable updating the RX buffer for the given USART. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{usart_8c_a823dd639b55929d621d419b43450a150}{core\+\_\+\+USART\+\_\+transmit}} (USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}usart, uint8\+\_\+t \texorpdfstring{$\ast$}{*}txbuf, uint8\+\_\+t txbuflen)
\begin{DoxyCompactList}\small\item\em Transmit data from a USART. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Core UART library. 

This core library component is used to initialize USARTs, transmit data over USART, and asynchronously receive data over USART.\hypertarget{usart_8c_autotoc_md14}{}\doxysubsubsection{\texorpdfstring{Initialization}{Initialization}}\label{usart_8c_autotoc_md14}
To initialize a USART for transmitting, user code must call the function \doxylink{usart_8c_a35dc06127bee8b23c08e4ec63aab66d3}{core\+\_\+\+USART\+\_\+init()} and specify the desired baud rate. To initialize a USART for receiving, user code can use either the \doxylink{usart_8c_a080787d9baeec30dbb2639ab958893bd}{core\+\_\+\+USART\+\_\+start\+\_\+rx()} or the \doxylink{usart_8c_a98eee6d24e7130a4a1c8527c207843a3}{core\+\_\+\+USART\+\_\+register\+\_\+callback()} functions.\hypertarget{usart_8c_autotoc_md15}{}\doxysubsubsection{\texorpdfstring{Receiving}{Receiving}}\label{usart_8c_autotoc_md15}
And data received over the USART will be stored to an internal buffer. The USART is configured to raise an interrupt if no data has been received for a certain time. What happens with the received data depends on which function was used to start the receiver.

If the receiver was started with \doxylink{usart_8c_a080787d9baeec30dbb2639ab958893bd}{core\+\_\+\+USART\+\_\+start\+\_\+rx()}, then the contents of the internal buffer and the number of bytes read will be copied into the buffers provided to \doxylink{usart_8c_a080787d9baeec30dbb2639ab958893bd}{core\+\_\+\+USART\+\_\+start\+\_\+rx()}. In this configuration, the user code will generally initialize its buffer length variable to zero and wait for its value to change. Before processing the data, it should call \doxylink{usart_8c_aa6d598f617dc2068c62544b474bc5960}{core\+\_\+\+USART\+\_\+update\+\_\+disable()} to prevent the interrupt handler from overwriting the receive buffer while its contents are being buffered. After processing the data in the receive buffer, the user code should set the buffer length variable back to zero and call \doxylink{usart_8c_a1c56db6aae9393622a2d93a74ec0b1d5}{core\+\_\+\+USART\+\_\+update\+\_\+enable()}.

If the receiver was started with \doxylink{usart_8c_a98eee6d24e7130a4a1c8527c207843a3}{core\+\_\+\+USART\+\_\+register\+\_\+callback()}, then the callback passed to \doxylink{usart_8c_a98eee6d24e7130a4a1c8527c207843a3}{core\+\_\+\+USART\+\_\+register\+\_\+callback()} will be called after a receiver timeout. A pointer to the internal buffer and the number of bytes received will be passed to the callback function. Note that the callback will be called from an ISR, so Free\+RTOS operations may not work.

\begin{DoxyNote}{Note}
If a receive timeout occurs while updating is disabled, then the data in the internal receive buffer will be lost. 
\end{DoxyNote}


\doxysubsection{Function Documentation}
\Hypertarget{usart_8c_a35dc06127bee8b23c08e4ec63aab66d3}\index{usart.c@{usart.c}!core\_USART\_init@{core\_USART\_init}}
\index{core\_USART\_init@{core\_USART\_init}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_init()}{core\_USART\_init()}}
{\footnotesize\ttfamily \label{usart_8c_a35dc06127bee8b23c08e4ec63aab66d3} 
bool core\+\_\+\+USART\+\_\+init (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{, }\item[{uint32\+\_\+t}]{baud}{}\end{DoxyParamCaption})}



Initialize a USART module in asynchronous mode with the given baud rate. 


\begin{DoxyParams}{Parameters}
{\em usart} & The USART module to initialize \\
\hline
{\em baud} & Baud rate \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em 0} & if the given USART is not valid of if the initialization failed \\
\hline
{\em 1} & otherwise \\
\hline
\end{DoxyRetVals}
\Hypertarget{usart_8c_a98eee6d24e7130a4a1c8527c207843a3}\index{usart.c@{usart.c}!core\_USART\_register\_callback@{core\_USART\_register\_callback}}
\index{core\_USART\_register\_callback@{core\_USART\_register\_callback}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_register\_callback()}{core\_USART\_register\_callback()}}
{\footnotesize\ttfamily \label{usart_8c_a98eee6d24e7130a4a1c8527c207843a3} 
bool core\+\_\+\+USART\+\_\+register\+\_\+callback (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{, }\item[{void(\texorpdfstring{$\ast$}{*}}]{callback~}{)(uint8\+\_\+t \texorpdfstring{$\ast$}{*}, uint32\+\_\+t)}\end{DoxyParamCaption})}



Set the RX callback and start the receiver for the given USART module. 


\begin{DoxyParams}{Parameters}
{\em usart} & The USART module \\
\hline
{\em callback} & Function to be called after data is received (the RX timeout elapses). The function must take a pointer to a byte array as the first argument and a uint32\+\_\+t length as the second argument \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em 0} & if the given USART is not valid \\
\hline
{\em 1} & otherwise \\
\hline
\end{DoxyRetVals}
\Hypertarget{usart_8c_a080787d9baeec30dbb2639ab958893bd}\index{usart.c@{usart.c}!core\_USART\_start\_rx@{core\_USART\_start\_rx}}
\index{core\_USART\_start\_rx@{core\_USART\_start\_rx}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_start\_rx()}{core\_USART\_start\_rx()}}
{\footnotesize\ttfamily \label{usart_8c_a080787d9baeec30dbb2639ab958893bd} 
bool core\+\_\+\+USART\+\_\+start\+\_\+rx (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{, }\item[{volatile uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{rxbuf}{, }\item[{volatile uint32\+\_\+t \texorpdfstring{$\ast$}{*}}]{rxbuflen}{}\end{DoxyParamCaption})}



Start the receiver for the given USART module. 


\begin{DoxyParams}{Parameters}
{\em usart} & The USART module \\
\hline
{\em rxbuf} & Location where received data from the USART should be stored \\
\hline
{\em rxbuflen} & Location where the number of received bytes should be stored \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em 0} & if the given USART is not valid \\
\hline
{\em 1} & otherwise \\
\hline
\end{DoxyRetVals}
\Hypertarget{usart_8c_a823dd639b55929d621d419b43450a150}\index{usart.c@{usart.c}!core\_USART\_transmit@{core\_USART\_transmit}}
\index{core\_USART\_transmit@{core\_USART\_transmit}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_transmit()}{core\_USART\_transmit()}}
{\footnotesize\ttfamily \label{usart_8c_a823dd639b55929d621d419b43450a150} 
bool core\+\_\+\+USART\+\_\+transmit (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{txbuf}{, }\item[{uint8\+\_\+t}]{txbuflen}{}\end{DoxyParamCaption})}



Transmit data from a USART. 

\begin{DoxyNote}{Note}
This function is blocking and will not return until all data has been transmitted. 
\end{DoxyNote}

\begin{DoxyParams}{Parameters}
{\em usart} & The USART module \\
\hline
{\em txbuf} & Location where the data to be transmitted is read from \\
\hline
{\em txbuflen} & Number of bytes to transmit \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em 1} & if transmission was successful \\
\hline
{\em 0} & otherwise \\
\hline
\end{DoxyRetVals}
\Hypertarget{usart_8c_aa6d598f617dc2068c62544b474bc5960}\index{usart.c@{usart.c}!core\_USART\_update\_disable@{core\_USART\_update\_disable}}
\index{core\_USART\_update\_disable@{core\_USART\_update\_disable}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_update\_disable()}{core\_USART\_update\_disable()}}
{\footnotesize\ttfamily \label{usart_8c_aa6d598f617dc2068c62544b474bc5960} 
void core\+\_\+\+USART\+\_\+update\+\_\+disable (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{}\end{DoxyParamCaption})}



Disable updating the RX buffer for the given USART. Use this before reading from the buffer to which data is stored to prevent corruption. 


\begin{DoxyParams}{Parameters}
{\em usart} & The USART module \\
\hline
\end{DoxyParams}
\Hypertarget{usart_8c_a1c56db6aae9393622a2d93a74ec0b1d5}\index{usart.c@{usart.c}!core\_USART\_update\_enable@{core\_USART\_update\_enable}}
\index{core\_USART\_update\_enable@{core\_USART\_update\_enable}!usart.c@{usart.c}}
\doxysubsubsection{\texorpdfstring{core\_USART\_update\_enable()}{core\_USART\_update\_enable()}}
{\footnotesize\ttfamily \label{usart_8c_a1c56db6aae9393622a2d93a74ec0b1d5} 
void core\+\_\+\+USART\+\_\+update\+\_\+enable (\begin{DoxyParamCaption}\item[{USART\+\_\+\+Type\+Def \texorpdfstring{$\ast$}{*}}]{usart}{}\end{DoxyParamCaption})}



Enable updating the RX buffer for the given USART. 

\begin{DoxyNote}{Note}
Receiving is disabled by default. Make sure to call core\+\_\+\+USART\+\_\+update\+\_\+enable after setting up the receiver with core\+\_\+\+USART\+\_\+start\+\_\+rx. 
\end{DoxyNote}

\begin{DoxyParams}{Parameters}
{\em usart} & The USART module \\
\hline
\end{DoxyParams}
