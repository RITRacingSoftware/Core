<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Core: src/driver/Src/usart.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="register_tables.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Core
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_4db3a2f7aa3a8b9901e70dfeb2571af9.html">driver</a></li><li class="navelem"><a class="el" href="dir_bd43694d282a1a6821503b447b4f5643.html">Src</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">usart.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Core UART library.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;usart.h&quot;</code><br />
<code>#include &quot;core_config.h&quot;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdarg.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;stm32g4xx_hal.h&gt;</code><br />
<code>#include &lt;stm32g4xx_hal_usart.h&gt;</code><br />
<code>#include &quot;clock.h&quot;</code><br />
<code>#include &quot;gpio.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a35dc06127bee8b23c08e4ec63aab66d3" id="r_a35dc06127bee8b23c08e4ec63aab66d3"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a35dc06127bee8b23c08e4ec63aab66d3">core_USART_init</a> (USART_TypeDef *usart, uint32_t baud)</td></tr>
<tr class="memdesc:a35dc06127bee8b23c08e4ec63aab66d3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize a USART module in asynchronous mode with the given baud rate.  <br /></td></tr>
<tr class="separator:a35dc06127bee8b23c08e4ec63aab66d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a080787d9baeec30dbb2639ab958893bd" id="r_a080787d9baeec30dbb2639ab958893bd"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a080787d9baeec30dbb2639ab958893bd">core_USART_start_rx</a> (USART_TypeDef *usart, volatile uint8_t *rxbuf, volatile uint32_t *rxbuflen)</td></tr>
<tr class="memdesc:a080787d9baeec30dbb2639ab958893bd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Start the receiver for the given USART module.  <br /></td></tr>
<tr class="separator:a080787d9baeec30dbb2639ab958893bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98eee6d24e7130a4a1c8527c207843a3" id="r_a98eee6d24e7130a4a1c8527c207843a3"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a98eee6d24e7130a4a1c8527c207843a3">core_USART_register_callback</a> (USART_TypeDef *usart, void(*callback)(uint8_t *, uint32_t))</td></tr>
<tr class="memdesc:a98eee6d24e7130a4a1c8527c207843a3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the RX callback and start the receiver for the given USART module.  <br /></td></tr>
<tr class="separator:a98eee6d24e7130a4a1c8527c207843a3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a27fb9800d727337121da9525aca0b557" id="r_a27fb9800d727337121da9525aca0b557"><td class="memItemLeft" align="right" valign="top"><a id="a27fb9800d727337121da9525aca0b557" name="a27fb9800d727337121da9525aca0b557"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>USART1_IRQHandler</b> ()</td></tr>
<tr class="separator:a27fb9800d727337121da9525aca0b557"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adec38e248f7515f0ee427630d5ff98ba" id="r_adec38e248f7515f0ee427630d5ff98ba"><td class="memItemLeft" align="right" valign="top"><a id="adec38e248f7515f0ee427630d5ff98ba" name="adec38e248f7515f0ee427630d5ff98ba"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>USART2_IRQHandler</b> ()</td></tr>
<tr class="separator:adec38e248f7515f0ee427630d5ff98ba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7ef0c8dc631c3684df826336b678dda0" id="r_a7ef0c8dc631c3684df826336b678dda0"><td class="memItemLeft" align="right" valign="top"><a id="a7ef0c8dc631c3684df826336b678dda0" name="a7ef0c8dc631c3684df826336b678dda0"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>USART3_IRQHandler</b> ()</td></tr>
<tr class="separator:a7ef0c8dc631c3684df826336b678dda0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa6d598f617dc2068c62544b474bc5960" id="r_aa6d598f617dc2068c62544b474bc5960"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#aa6d598f617dc2068c62544b474bc5960">core_USART_update_disable</a> (USART_TypeDef *usart)</td></tr>
<tr class="memdesc:aa6d598f617dc2068c62544b474bc5960"><td class="mdescLeft">&#160;</td><td class="mdescRight">Disable updating the RX buffer for the given USART. Use this before reading from the buffer to which data is stored to prevent corruption.  <br /></td></tr>
<tr class="separator:aa6d598f617dc2068c62544b474bc5960"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1c56db6aae9393622a2d93a74ec0b1d5" id="r_a1c56db6aae9393622a2d93a74ec0b1d5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a1c56db6aae9393622a2d93a74ec0b1d5">core_USART_update_enable</a> (USART_TypeDef *usart)</td></tr>
<tr class="memdesc:a1c56db6aae9393622a2d93a74ec0b1d5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enable updating the RX buffer for the given USART.  <br /></td></tr>
<tr class="separator:a1c56db6aae9393622a2d93a74ec0b1d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a823dd639b55929d621d419b43450a150" id="r_a823dd639b55929d621d419b43450a150"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a823dd639b55929d621d419b43450a150">core_USART_transmit</a> (USART_TypeDef *usart, uint8_t *txbuf, uint8_t txbuflen)</td></tr>
<tr class="memdesc:a823dd639b55929d621d419b43450a150"><td class="mdescLeft">&#160;</td><td class="mdescRight">Transmit data from a USART.  <br /></td></tr>
<tr class="separator:a823dd639b55929d621d419b43450a150"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Core UART library. </p>
<p>This core library component is used to initialize USARTs, transmit data over USART, and asynchronously receive data over USART.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Initialization</h2>
<p>To initialize a USART for transmitting, user code must call the function <a class="el" href="#a35dc06127bee8b23c08e4ec63aab66d3" title="Initialize a USART module in asynchronous mode with the given baud rate.">core_USART_init()</a> and specify the desired baud rate. To initialize a USART for receiving, user code can use either the <a class="el" href="#a080787d9baeec30dbb2639ab958893bd" title="Start the receiver for the given USART module.">core_USART_start_rx()</a> or the <a class="el" href="#a98eee6d24e7130a4a1c8527c207843a3" title="Set the RX callback and start the receiver for the given USART module.">core_USART_register_callback()</a> functions.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Receiving</h2>
<p>And data received over the USART will be stored to an internal buffer. The USART is configured to raise an interrupt if no data has been received for a certain time. What happens with the received data depends on which function was used to start the receiver.</p>
<p>If the receiver was started with <a class="el" href="#a080787d9baeec30dbb2639ab958893bd" title="Start the receiver for the given USART module.">core_USART_start_rx()</a>, then the contents of the internal buffer and the number of bytes read will be copied into the buffers provided to <a class="el" href="#a080787d9baeec30dbb2639ab958893bd" title="Start the receiver for the given USART module.">core_USART_start_rx()</a>. In this configuration, the user code will generally initialize its buffer length variable to zero and wait for its value to change. Before processing the data, it should call <a class="el" href="#aa6d598f617dc2068c62544b474bc5960" title="Disable updating the RX buffer for the given USART. Use this before reading from the buffer to which ...">core_USART_update_disable()</a> to prevent the interrupt handler from overwriting the receive buffer while its contents are being buffered. After processing the data in the receive buffer, the user code should set the buffer length variable back to zero and call <a class="el" href="#a1c56db6aae9393622a2d93a74ec0b1d5" title="Enable updating the RX buffer for the given USART.">core_USART_update_enable()</a>.</p>
<p>If the receiver was started with <a class="el" href="#a98eee6d24e7130a4a1c8527c207843a3" title="Set the RX callback and start the receiver for the given USART module.">core_USART_register_callback()</a>, then the callback passed to <a class="el" href="#a98eee6d24e7130a4a1c8527c207843a3" title="Set the RX callback and start the receiver for the given USART module.">core_USART_register_callback()</a> will be called after a receiver timeout. A pointer to the internal buffer and the number of bytes received will be passed to the callback function. Note that the callback will be called from an ISR, so FreeRTOS operations may not work.</p>
<dl class="section note"><dt>Note</dt><dd>If a receive timeout occurs while updating is disabled, then the data in the internal receive buffer will be lost. </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a35dc06127bee8b23c08e4ec63aab66d3" name="a35dc06127bee8b23c08e4ec63aab66d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a35dc06127bee8b23c08e4ec63aab66d3">&#9670;&#160;</a></span>core_USART_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool core_USART_init </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t</td>          <td class="paramname"><span class="paramname"><em>baud</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize a USART module in asynchronous mode with the given baud rate. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module to initialize </td></tr>
    <tr><td class="paramname">baud</td><td>Baud rate </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if the given USART is not valid of if the initialization failed </td></tr>
    <tr><td class="paramname">1</td><td>otherwise </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a98eee6d24e7130a4a1c8527c207843a3" name="a98eee6d24e7130a4a1c8527c207843a3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a98eee6d24e7130a4a1c8527c207843a3">&#9670;&#160;</a></span>core_USART_register_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool core_USART_register_callback </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void(*</td>          <td class="paramname"><span class="paramname"><em>callback&#160;</em></span>)(uint8_t *, uint32_t)&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the RX callback and start the receiver for the given USART module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module </td></tr>
    <tr><td class="paramname">callback</td><td>Function to be called after data is received (the RX timeout elapses). The function must take a pointer to a byte array as the first argument and a uint32_t length as the second argument </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if the given USART is not valid </td></tr>
    <tr><td class="paramname">1</td><td>otherwise </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a080787d9baeec30dbb2639ab958893bd" name="a080787d9baeec30dbb2639ab958893bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a080787d9baeec30dbb2639ab958893bd">&#9670;&#160;</a></span>core_USART_start_rx()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool core_USART_start_rx </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">volatile uint8_t *</td>          <td class="paramname"><span class="paramname"><em>rxbuf</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">volatile uint32_t *</td>          <td class="paramname"><span class="paramname"><em>rxbuflen</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Start the receiver for the given USART module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module </td></tr>
    <tr><td class="paramname">rxbuf</td><td>Location where received data from the USART should be stored </td></tr>
    <tr><td class="paramname">rxbuflen</td><td>Location where the number of received bytes should be stored </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if the given USART is not valid </td></tr>
    <tr><td class="paramname">1</td><td>otherwise </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a823dd639b55929d621d419b43450a150" name="a823dd639b55929d621d419b43450a150"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a823dd639b55929d621d419b43450a150">&#9670;&#160;</a></span>core_USART_transmit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool core_USART_transmit </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *</td>          <td class="paramname"><span class="paramname"><em>txbuf</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>txbuflen</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Transmit data from a USART. </p>
<dl class="section note"><dt>Note</dt><dd>This function is blocking and will not return until all data has been transmitted. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module </td></tr>
    <tr><td class="paramname">txbuf</td><td>Location where the data to be transmitted is read from </td></tr>
    <tr><td class="paramname">txbuflen</td><td>Number of bytes to transmit </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">1</td><td>if transmission was successful </td></tr>
    <tr><td class="paramname">0</td><td>otherwise </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="aa6d598f617dc2068c62544b474bc5960" name="aa6d598f617dc2068c62544b474bc5960"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa6d598f617dc2068c62544b474bc5960">&#9670;&#160;</a></span>core_USART_update_disable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void core_USART_update_disable </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Disable updating the RX buffer for the given USART. Use this before reading from the buffer to which data is stored to prevent corruption. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a1c56db6aae9393622a2d93a74ec0b1d5" name="a1c56db6aae9393622a2d93a74ec0b1d5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1c56db6aae9393622a2d93a74ec0b1d5">&#9670;&#160;</a></span>core_USART_update_enable()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void core_USART_update_enable </td>
          <td>(</td>
          <td class="paramtype">USART_TypeDef *</td>          <td class="paramname"><span class="paramname"><em>usart</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enable updating the RX buffer for the given USART. </p>
<dl class="section note"><dt>Note</dt><dd>Receiving is disabled by default. Make sure to call core_USART_update_enable after setting up the receiver with core_USART_start_rx. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">usart</td><td>The USART module </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
